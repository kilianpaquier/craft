# Code generated by craft; DO NOT EDIT.

LABEL org.opencontainers.image.authors="kilianpaquier <kilianpaquier@users.noreply.github.com>"
LABEL org.opencontainers.image.vendor="kilianpaquier"

LABEL org.opencontainers.image.title="golang-app"
LABEL org.opencontainers.image.licenses="MIT"
LABEL org.opencontainers.image.url="gitlab.com/kilianpaquier/craft/examples/golang-app"
LABEL org.opencontainers.image.source="gitlab.com/kilianpaquier/craft/examples/golang-app"
LABEL org.opencontainers.image.documentation="gitlab.com/kilianpaquier/craft/examples/golang-app"

#############################
#        STAGE BUILD        #
#############################
FROM golang:latest AS build

WORKDIR /app

COPY . .

# hadolint ignore=DL3059
RUN go mod download
# hadolint ignore=DL3059
RUN CGO_ENABLED=0 go build -o cron-refresh cmd/cron-refresh/main.go
# hadolint ignore=DL3059
RUN CGO_ENABLED=0 go build -o worker-appli cmd/worker-appli/main.go

#############################
#         STAGE RUN         #
#############################
FROM gcr.io/distroless/static-debian12

RUN addgroup -S nonroot && adduser -S nonroot -G nonroot

WORKDIR /app

COPY --from=build \
    /app/cron-refresh \
    /app/worker-appli \
    ./
COPY launcher.sh launcher.sh

EXPOSE 3000

USER nonroot

ENTRYPOINT [ "/app/launcher.sh" ]