# Code generated by craft; DO NOT EDIT.

name: Docker
description: Run hadolint on Dockerfile, build the docker image, deploys it and then run trivy security analysis on it

inputs:
  registry:
    default: ""
    description: Docker registry on which push the docker image. By default it will be Docker Hub.
  image:
    default: ${{ github.repository }}
    description: Full docker image name (without registry). By default it will be ${{ github.repository }}.
  version:
    description: Docker image version.
    required: true
  registry_token:
    description: Docker registry access token.
    required: true

runs:
  using: composite
  steps:
    - uses: actions/checkout@v4

    ########################################################
    # Hadolint
    ########################################################

    - uses: hadolint/hadolint-action@v3.1.0
      with:
        format: sarif
        output-file: hadolint-results.sarif
    - if: ${{ ! cancelled() }}
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: hadolint-results.sarif
        category: docker-hadolint
    - id: hadolint
      if: ${{ ! cancelled() }}
      uses: hadolint/hadolint-action@v3.1.0
      with:
        format: tty

    ########################################################
    # Build
    ########################################################

    - id: image
      shell: bash
      run: |
        if [ "${REGISTRY}" != "" ]; then
          docker_image="${DOCKER_REGISTRY}/${DOCKER_IMAGE}"
        else
          docker_image="${DOCKER_IMAGE}"
        fi
        echo "image=${docker_image}" >> $GITHUB_OUTPUT
      env:
        DOCKER_IMAGE: ${{ inputs.image }}
        DOCKER_REGISTRY: ${{ inputs.registry }}
    - id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ steps.image.outputs.image }}
        labels: |
          org.opencontainers.image.created={{date 'YYYY-MM-DDTHH:mm:ssZ'}}
          org.opencontainers.image.ref.name="${{ github.ref_name }}"
          org.opencontainers.image.version="${{ inputs.version }}"
          org.opencontainers.image.revision="${{ github.sha }}"
        tags: |
          type=raw,enable={{is_default_branch}},value=latest
          type=semver,enable=true,pattern={{raw}},value=${{ inputs.version }}
          type=semver,enable=${{ github.ref_type == 'tag' }},pattern=v{{major}}.{{minor}},value=${{ inputs.version }}
          type=semver,enable=${{ github.ref_type == 'tag' }},pattern=v{{major}},value=${{ inputs.version }}
    - uses: docker/setup-buildx-action@v3
    - uses: docker/login-action@v3
      with:
        registry: ${{ inputs.registry }}
        username: ${{ github.repository_owner }}
        password: ${{ inputs.registry_token }}
    - uses: docker/build-push-action@v6
      with:
        context: .
        labels: ${{ steps.meta.outputs.labels }}
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}

    ########################################################
    # Trivy
    ########################################################

    - uses: aquasecurity/trivy-action@master
      with:
        format: sarif
        ignore-unfixed: false
        image-ref: ${{ steps.image.outputs.image }}:${{ inputs.version }}
        output: trivy-results.sarif
        severity: MEDIUM,HIGH,CRITICAL
      env:
        TRIVY_USERNAME: ${{ github.repository_owner }}
        TRIVY_PASSWORD: ${{ inputs.registry_token }}
    - uses: github/codeql-action/upload-sarif@v3
      with:
        category: docker-trivy
        sarif_file: trivy-results.sarif
    - uses: aquasecurity/trivy-action@master
      with:
        exit-code: "1"
        ignore-unfixed: false
        image-ref: ${{ steps.image.outputs.image }}:${{ inputs.version }}
        severity: MEDIUM,HIGH,CRITICAL
      env:
        TRIVY_USERNAME: ${{ github.repository_owner }}
        TRIVY_PASSWORD: ${{ inputs.registry_token }}