# Code generated by craft; DO NOT EDIT.

<<- $nodejs := hasKey .Languages "nodejs" >>
<<- $hugo := hasKey .Languages "hugo" >>
<<- $golang := hasKey .Languages "golang" >>

<<- $gobuild := and $golang (gt (len .Clis) 0) (not .NoGoreleaser) >>
<<- $docker := and .Docker (gt .Binaries 0) >>

<<- $pages := and (.IsStatic "pages") (or $nodejs $hugo) >>
<<- $netlify := and (.IsStatic "netlify") (or $nodejs $hugo) >>

---
include:

  # semantic-release template
  - project: "to-be-continuous/semantic-release"
    ref: "3"
    file: "templates/gitlab-ci-semrel.yml"

<<- if .IsBot "renovate" >>

  # Renovate template
  - project: "to-be-continuous/renovate"
    ref: "1"
    file: "templates/gitlab-ci-renovate.yml"
<<- end >>

<<- if $docker >>

  # Docker template
  - project: "to-be-continuous/docker"
    ref: "5"
    file: "templates/gitlab-ci-docker.yml"
<<- end >>

<<- if $golang >>

  # Go template
  - project: "to-be-continuous/golang"
    ref: "4"
    file: "templates/gitlab-ci-golang.yml"
<<- end >>

<<- if $nodejs >>

  # Node.js template
  - project: "to-be-continuous/node"
    ref: "3"
    file: "templates/gitlab-ci-node.yml"
<<- end >>

<<- if has "sonar" .CI.Options >>

  # SonarQube template
  - project: "to-be-continuous/sonar"
    ref: "4"
    file: "templates/gitlab-ci-sonar.yml"
<<- end >>

variables:
<<- if .IsBot "renovate" >>

  RENOVATE_AUTODISCOVER: "true"
  RENOVATE_AUTODISCOVER_FILTER: ${CI_PROJECT_PATH}
<<- end >>

<<- if $docker >>
<<- if .Docker.Registry >>

  CI_REGISTRY: << .Docker.Registry >>
<<- end >>

  DOCKER_HEALTHCHECK_DISABLED: "true" # https://docs.docker.com/reference/dockerfile/#healthcheck
  DOCKER_KANIKO_IMAGE: "gcr.io/kaniko-project/executor:debug"
  DOCKER_METADATA: |
    --label org.opencontainers.image.created=${CI_JOB_STARTED_AT}
    --label org.opencontainers.image.ref.name=${CI_COMMIT_REF_NAME}
    --label org.opencontainers.image.revision=${CI_COMMIT_SHA}
    --label org.opencontainers.image.version=${SEMREL_INFO_NEXT_VERSION}
  DOCKER_RELEASE_EXTRA_TAGS: "latest \\g<major>.\\g<minor> \\g<major"
  DOCKER_RELEASE_IMAGE: "${CI_REGISTRY_IMAGE}:${SEMREL_INFO_NEXT_VERSION}"
  DOCKER_SBOM_DISABLED: "true" # https://github.com/anchore/syft
  DOCKER_SEMREL_RELEASE_DISABLED: "true" # handled by docker build and push jobs to avoid too much dependency on semantic-release
  DOCKER_SNAPSHOT_IMAGE: "${CI_REGISTRY_IMAGE}:${SEMREL_INFO_NEXT_VERSION}"
  DOCKER_TRIVY_ARGS: "--ignore-unfixed --exit-code 1 --exit-on-eol 1"
  DOCKER_TRIVY_SECURITY_LEVEL_THRESHOLD: "MEDIUM,HIGH,CRITICAL"
<<- end >>

<<- if $nodejs >>

  NODE_AUDIT_DISABLED: "false"
  NODE_BUILD_ARGS: "run build --prod"
  NODE_IMAGE: "registry.hub.docker.com/library/node:lts-alpine"
  NODE_LINT_ARGS: "run lint"
  NODE_LINT_ENABLED: "true"
  NODE_OUTDATED_ARGS: "--long"
  NODE_OUTDATED_DISABLED: "false"
  NODE_PUBLISH_ENABLED: "false"
  NODE_SBOM_DISABLED: "true"
  NODE_SEMGREP_DISABLED: "false" # https://semgrep.dev/docs/
  NODE_TEST_ARGS: "test -- --coverage"
<<- end >>

<<- if $golang >>

  GO_CI_LINT_ARGS: "--config .golangci.yml --timeout 240s --fast --sort-results"
  GO_CI_LINT_IMAGE: "registry.hub.docker.com/golangci/golangci-lint:latest-alpine"
  GO_IMAGE: "registry.hub.docker.com/library/golang:latest"
  GO_OUTDATED_DISABLED: "false" # https://github.com/psampaz/go-mod-outdated
  GO_SBOM_DISABLED: "true"
  GO_TEST_FLAGS: "-coverpkg=./... -covermode=count"
  GO_TEST_IMAGE: "registry.hub.docker.com/library/golang:latest"
<<- end >>

<<- if has "sonar" .CI.Options >>

  SONAR_HOST_URL: "https://sonarcloud.io"
  SONAR_BASE_ARGS: |
    -Dsonar.properties=sonar.properties
    -Dsonar.links.homepage=${CI_PROJECT_URL}
    -Dsonar.links.ci=${CI_PROJECT_URL}/-/pipelines
    -Dsonar.links.issue=${CI_PROJECT_URL}/-/issues
  SONAR_QUALITY_GATE_ENABLED: "true"
<<- end >>

  GIT_AUTHOR_EMAIL: ${GITLAB_USER_EMAIL}
  GIT_COMMITTER_EMAIL: ${GITLAB_USER_EMAIL}

  SEMREL_TAG_FORMAT: v$${version}
  SEMREL_REQUIRED_PLUGINS_FILE: .gitlab/semrel-plugins.txt
  SEMREL_HOOKS_DIR: scripts
  SEMREL_INFO_ON: all
  SEMREL_RELEASE_DISABLED: << if .CI.Release >>"false"<< else >>"true"<< end >>
  SEMREL_AUTO_RELEASE_ENABLED: << if and .CI.Release .CI.Release.Auto >>"true"<< else >>"false"<< end >>

semantic-release-info:
  after_script:
    - source "${SEMREL_CONFIG_DIR}/semrel.out.env" && rm "${SEMREL_CONFIG_DIR}/semrel.out.env"
    - BRANCH_SHA=$(echo "${CI_COMMIT_REF_NAME}" | sha256sum | cut -c -8)
    - echo "BRANCH_SHA=${BRANCH_SHA}" >> "${SEMREL_CONFIG_DIR}/semrel.out.env"
    - >
      if echo "$SEMREL_INFO_NEXT_VERSION" | grep -Eq "^[0-9]+(\.[0-9]+){2}.*$"; then
        echo "SEMREL_INFO_LAST_VERSION=v${SEMREL_INFO_LAST_VERSION#v}" >> "${SEMREL_CONFIG_DIR}/semrel.out.env"
        echo "SEMREL_INFO_NEXT_VERSION=v$SEMREL_INFO_NEXT_VERSION" >> "${SEMREL_CONFIG_DIR}/semrel.out.env"
        echo "SEMREL_INFO_NEXT_VERSION_TYPE=${SEMREL_INFO_NEXT_VERSION_TYPE}" >> "${SEMREL_CONFIG_DIR}/semrel.out.env"
        cat "${SEMREL_CONFIG_DIR}/semrel.out.env"
        exit 0
      fi

      git fetch --tags

      if [ "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" != "" ]; then
        if echo "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" | grep -Eq "^v[0-9]+\.x$"; then
          SEARCH="${CI_MERGE_REQUEST_TARGET_BRANCH_NAME%%.x*}"
        elif echo "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" | grep -Eq "^v[0-9]+\.[0-9]+\.x$"; then
          SEARCH="${CI_MERGE_REQUEST_TARGET_BRANCH_NAME%%.x*}"
        fi
      fi

      SEMREL_INFO_LAST_VERSION=$(git tag --list | sort -V | grep -E "${SEARCH}" | tail -n1)

      SEMREL_INFO_NEXT_VERSION=${SEMREL_INFO_LAST_VERSION-1.0.0}
      SEMREL_INFO_NEXT_VERSION=${SEMREL_INFO_NEXT_VERSION%-*}

    - echo "SEMREL_INFO_LAST_VERSION=v${SEMREL_INFO_LAST_VERSION#v}" >> "${SEMREL_CONFIG_DIR}/semrel.out.env"
    - echo "SEMREL_INFO_NEXT_VERSION=v${SEMREL_INFO_NEXT_VERSION#v}-build.${BRANCH_SHA}" >> "${SEMREL_CONFIG_DIR}/semrel.out.env"
    - echo "SEMREL_INFO_NEXT_VERSION_TYPE=build" >> "${SEMREL_CONFIG_DIR}/semrel.out.env"
    - cat "${SEMREL_CONFIG_DIR}/semrel.out.env"

<<- if and .CI.Release .CI.Release.Backmerge >>

semantic-release:
  variables:
    GIT_DEPTH: "0"
<<- end >>

<<- if $gobuild >>

go-build:
  image: ghcr.io/goreleaser/goreleaser:latest
  script:
    - goreleaser release --clean --config .goreleaser.yml --skip=validate --skip=announce --skip=publish --snapshot
  artifacts:
    name: "$CI_JOB_NAME artifacts from $CI_PROJECT_NAME on $CI_COMMIT_REF_SLUG"
    paths:
      - dist
      - checksums.txt
    expire_in: 1 day
<<- else if $golang >>

go-build:
  when: never
<<- end >>

<<- if $hugo >>

hugo-build:
  image: registry.gitlab.com/pages/hugo/hugo_extended:latest
  stage: build
  variables:
    DIST_FOLDER: dist
  before_script:
    - apk add go
  script:
    - hugo --gc --minify --destination "$DIST_FOLDER"
  artifacts:
    name: $ENV
    paths:
      - $DIST_FOLDER
    expire_in: 1 day
<<- end >>

<<- if $netlify >>

netlify:
  stage: deploy
  image: node:lts-alpine
  environment:
    name: $ENV
    action: start
  variables:
    DIST_FOLDER: dist
  rules:
    - if: $CI_COMMIT_REF_PROTECTED == 'true'
      variables:
        ARGS: "--prod"
        ENV: production
<<- if not .CI.Static.Auto >>
      when: manual
<<- end >>
    - variables:
        ARGS: "--alias $BRANCH_SHA" # sha is coming from version.yml file with export from semantic-release-info job
        ENV: $CI_COMMIT_REF_NAME
      when: manual
  before_script:
    - npm install -g netlify-cli
  script:
    - netlify deploy --site "$NETLIFY_SITE_ID" --auth "$NETLIFY_AUTH_TOKEN" --dir "$DIST_FOLDER" "$ARGS"
<<- end >>

<<- if $pages >>

pages:
  stage: deploy
  environment:
    name: $ENV
    action: start
    url: $CI_PAGES_URL
  variables:
    ENV: production
    DIST_FOLDER: dist
  rules:
    - if: $CI_COMMIT_REF_PROTECTED == 'true'
<<- if not .CI.Static.Auto >>
      when: manual
<<- end >>
  script:
    - >
      if [ "$DIST_FOLDER" != "public" ]; then
        mkdir -p public
        $DIST_FOLDER/* public
      fi
  artifacts:
    name: $ENV
    paths:
      - public
    expire_in: 1 day
<<- end >>