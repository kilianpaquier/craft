jobs:
<<- define "helm" >>

  helm-lint-test:
    name: Helm Lint & Test
    runs-on: ubuntu-latest
    needs: run-workflow
    steps:
      - uses: actions/checkout@v4
      # https://github.com/marketplace/actions/helm-tool-installer
      - uses: azure/setup-helm@v4
        with:
          version: v3.16.2
      - uses: actions/setup-python@v5
        with:
          check-latest: true
          python-version: 3.x
      # https://github.com/marketplace/actions/helm-chart-testing
      - uses: helm/chart-testing-action@v2
      - id: list-changed
        run: |
          changed=$(ct list-changed --target-branch "${DEFAULT_BRANCH}")
          if [[ -n "$changed" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
      - if: ${{ steps.list-changed.outputs.changed == 'true' }}
        run: ct lint --target-branch "${DEFAULT_BRANCH}"
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
      - if: ${{ steps.list-changed.outputs.changed == 'true' }}
        uses: helm/kind-action@v1
      - if: ${{ steps.list-changed.outputs.changed == 'true' }}
        run: ct install --target-branch "${DEFAULT_BRANCH}"
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
<<- end >>